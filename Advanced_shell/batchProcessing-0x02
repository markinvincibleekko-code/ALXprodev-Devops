#!/bin/bash

# Task 2 & 4: Batch Pokémon Data Retrieval with Error Handling and Retry Logic
# Objective: Automate retrieval with robust error handling and retry mechanism

# Configuration
POKEMON_LIST=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")
OUTPUT_DIR="pokemon_data"
ERROR_FILE="errors.txt"
API_BASE_URL="https://pokeapi.co/api/v2/pokemon"
DELAY_SECONDS=1  # Delay between requests to avoid rate limiting
MAX_RETRIES=3    # Maximum number of retry attempts
RETRY_DELAY=2    # Delay between retry attempts in seconds

# Function to log errors
log_error() {
    local error_message="$1"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: ${error_message}" >> "${ERROR_FILE}"
}

# Function to create output directory
setup_directory() {
    if [ ! -d "${OUTPUT_DIR}" ]; then
        mkdir -p "${OUTPUT_DIR}"
        if [ $? -ne 0 ]; then
            log_error "Failed to create directory ${OUTPUT_DIR}"
            echo "ERROR: Could not create output directory"
            exit 1
        fi
    fi
}

# Function to fetch data for a single Pokemon with retry logic
fetch_pokemon_with_retry() {
    local pokemon_name="$1"
    local api_url="${API_BASE_URL}/${pokemon_name}"
    local output_file="${OUTPUT_DIR}/${pokemon_name}.json"
    local attempt=1
    
    echo "Fetching data for ${pokemon_name}..."
    
    # Retry loop
    while [ ${attempt} -le ${MAX_RETRIES} ]; do
        # Make the API request with curl
        # -s: silent mode
        # -S: show errors
        # -w: write out HTTP status code
        # -o: output file
        # --connect-timeout: connection timeout in seconds
        # --max-time: maximum time for the entire operation
        http_code=$(curl -s -S -w "%{http_code}" -o "${output_file}" \
                    --connect-timeout 10 --max-time 30 "${api_url}" 2>&1)
        
        # Check curl exit status
        curl_exit_code=$?
        
        # If curl command succeeded
        if [ ${curl_exit_code} -eq 0 ]; then
            # Extract HTTP status code (last 3 characters)
            http_status="${http_code: -3}"
            
            # Check if HTTP status code is 200 (OK)
            if [ "${http_status}" = "200" ]; then
                # Verify the output file exists and is not empty
                if [ -s "${output_file}" ]; then
                    # Verify it's valid JSON
                    if jq empty "${output_file}" 2>/dev/null; then
                        echo "Saved data to ${output_file} ✅"
                        return 0
                    else
                        log_error "Invalid JSON for ${pokemon_name} on attempt ${attempt}"
                    fi
                else
                    log_error "Empty response for ${pokemon_name} on attempt ${attempt}"
                fi
            elif [ "${http_status}" = "404" ]; then
                # 404 means invalid Pokemon name - don't retry
                log_error "Invalid Pokemon name: ${pokemon_name} (HTTP 404)"
                echo "Failed to fetch ${pokemon_name} - Invalid name ❌"
                [ -f "${output_file}" ] && rm "${output_file}"
                return 1
            else
                log_error "HTTP ${http_status} for ${pokemon_name} on attempt ${attempt}"
            fi
        else
            # Network error or curl failure
            log_error "Network error for ${pokemon_name} on attempt ${attempt} (curl exit code: ${curl_exit_code})"
        fi
        
        # If we reach here, the request failed
        if [ ${attempt} -lt ${MAX_RETRIES} ]; then
            echo "Attempt ${attempt}/${MAX_RETRIES} failed. Retrying in ${RETRY_DELAY} seconds..."
            sleep ${RETRY_DELAY}
        else
            # Final attempt failed
            log_error "Failed to fetch ${pokemon_name} after ${MAX_RETRIES} attempts"
            echo "Failed to fetch ${pokemon_name} after ${MAX_RETRIES} attempts ❌"
            [ -f "${output_file}" ] && rm "${output_file}"
            return 1
        fi
        
        attempt=$((attempt + 1))
    done
    
    return 1
}

# Function to process all Pokemon
process_all_pokemon() {
    local success_count=0
    local fail_count=0
    
    for pokemon in "${POKEMON_LIST[@]}"; do
        if fetch_pokemon_with_retry "${pokemon}"; then
            ((success_count++))
        else
            ((fail_count++))
        fi
        
        # Add delay between requests to avoid rate limiting
        # Skip delay after the last Pokemon
        if [ "${pokemon}" != "${POKEMON_LIST[-1]}" ]; then
            sleep ${DELAY_SECONDS}
        fi
    done
    
    # Display summary if there were any failures
    if [ ${fail_count} -gt 0 ]; then
        echo ""
        echo "Summary: ${success_count} successful, ${fail_count} failed"
        echo "Check ${ERROR_FILE} for details"
    fi
    
    return 0
}

# Main execution
main() {
    # Setup output directory
    setup_directory
    
    # Process all Pokemon
    process_all_pokemon
    
    exit 0
}

# Run the main function
main