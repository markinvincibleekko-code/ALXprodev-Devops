#!/bin/bash

# Task 0: API Request Automation
# Objective: Automate API requests to PokÃ©mon API and save results

# Configuration
POKEMON_NAME="pikachu"
API_URL="https://pokeapi.co/api/v2/pokemon/${POKEMON_NAME}"
OUTPUT_FILE="data.json"
ERROR_FILE="errors.txt"

# Function to log errors
log_error() {
    local error_message="$1"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: ${error_message}" >> "${ERROR_FILE}"
}

# Function to make API request
fetch_pokemon_data() {
    echo "Fetching data for ${POKEMON_NAME}..."
    
    # Make the API request with curl
    # -s: silent mode (no progress bar)
    # -S: show errors even in silent mode
    # -w: write out HTTP status code
    # -o: output file
    http_code=$(curl -s -S -w "%{http_code}" -o "${OUTPUT_FILE}" "${API_URL}" 2>&1)
    
    # Check curl exit status
    curl_exit_code=$?
    
    # Handle different error scenarios
    if [ ${curl_exit_code} -ne 0 ]; then
        log_error "curl command failed with exit code ${curl_exit_code}"
        log_error "Failed to fetch data from ${API_URL}"
        echo "ERROR: Failed to fetch data. Check ${ERROR_FILE} for details."
        return 1
    fi
    
    # Extract HTTP status code (last 3 characters)
    http_status="${http_code: -3}"
    
    # Check if HTTP status code is 200 (OK)
    if [ "${http_status}" != "200" ]; then
        log_error "HTTP request failed with status code ${http_status}"
        log_error "URL: ${API_URL}"
        echo "ERROR: HTTP request failed with status ${http_status}. Check ${ERROR_FILE} for details."
        
        # Remove the output file if it contains error response
        [ -f "${OUTPUT_FILE}" ] && rm "${OUTPUT_FILE}"
        return 1
    fi
    
    # Verify the output file exists and is not empty
    if [ ! -s "${OUTPUT_FILE}" ]; then
        log_error "Output file is empty or does not exist"
        echo "ERROR: No data received. Check ${ERROR_FILE} for details."
        return 1
    fi
    
    # Verify it's valid JSON (optional but good practice)
    if ! jq empty "${OUTPUT_FILE}" 2>/dev/null; then
        log_error "Invalid JSON response received"
        echo "ERROR: Invalid JSON data. Check ${ERROR_FILE} for details."
        return 1
    fi
    
    echo "SUCCESS: Data saved to ${OUTPUT_FILE}"
    return 0
}

# Main execution
main() {
    # Clean up old error file if starting fresh (optional)
    # rm -f "${ERROR_FILE}"
    
    # Fetch the data
    if fetch_pokemon_data; then
        echo "Pokemon data retrieved successfully!"
        exit 0
    else
        echo "Failed to retrieve Pokemon data."
        exit 1
    fi
}

# Run the main function
main